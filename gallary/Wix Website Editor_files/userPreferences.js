define("userPreferences",["lodash","jquery","util"],function(a,b,c){"use strict";function e(){function g(){return c.url.isTrue("fakeUserPrefs")}function h(a){var b=c.url.getParameterByName("resetUserPrefs").toLowerCase();return"all"===b||b===a}function i(b,c){switch(b){case f.global.id:return c.global_preferences;case f.site.id:return a.mapValues(c,function(a){return{value:a,isDirty:!1}});default:return console.error("unknown type ID"),{}}}function j(a,b){f.global.data={},t(f.global.id,a,b)}function k(b,c){a.forEach(f.site.data,function(a){a.value=null,a.isDirty=!0}),t(f.site.id,b,c)}function l(b){var c={nameSpace:"htmlEditor",siteId:e,data:{}};return a.forEach(b,function(a,b){a.isDirty&&(c.data[b]=a.value)}),c}function m(a){return{nameSpace:"htmlEditor",key:"global_preferences",blob:a}}function n(a){switch(a){case f.global.id:return m(f.global.data);case f.site.id:return l(f.site.data)}}function o(b){switch(b){case f.global.id:return{global_preferences:f.global.data};case f.site.id:var c={};return a.forEach(f.site.data,function(a,b){c[b]=a.value}),c;default:return console.error("unknown type ID"),{}}}function p(a,b,c,d){f[a].data=b?i(a,b):{},h(a)?s(a,c,d):c&&c()}function q(b){b===f.site.id&&a.forEach(f.site.data,function(a){a.isDirty=!1})}function r(a,c,d){if(g()){var e=window.sessionStorage.getItem("user_prefs_"+f[a].id);return void p(a,JSON.parse(e),c,d)}b.ajax(f[a].urls.getLoadUrl(),{type:"GET",success:function(b){p(a,b,c,d)},error:function(a){d&&d(a)}})}function s(a,b,c){switch(a){case f.global.id:return j(b,c);case f.site.id:return k(b,c)}}function t(a,c,d){if(null===f[a].data)return void(d&&d("saving "+a+" preferences failed since they were not loaded"));if(g()){var e=o(a);return window.sessionStorage.setItem("user_prefs_"+f[a].id,JSON.stringify(e)),q(a),void(c&&c())}b.ajax(f[a].urls.getSaveUrl(),{type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(n(a)),success:function(){q(a),c&&c()},error:function(a){d&&d(a)}})}function u(b,c){function d(a){function d(){if(a&&a.responseText){var b=a.responseText.match(/errorCode="(\d+)"/);return b=b&&b[1],"3001"===b}return!1}return d()?(f.global.data={},void b()):(f.global.data=null,console.error("Global preferences failed to load!"),void c("Global preferences failed to load!"))}b=b||a.noop,c=c||a.noop,r(f.global.id,b,d)}function v(b,c,d,g){var h=a.isEmpty(f.site.data);if(e=b,c)h||t(f.site.id,d,g);else if(h)r(f.site.id,d,function(){console.error("Site preferences failed to load!"),g&&g("Site preferences failed to load!")});else{var i=a.clone(f.site.data),j=t.bind(this,f.site.id,d,g),k=function(){f.site.data=a.merge(f.site.data,i),j()};r(f.site.id,k,function(){console.error("Site preferences failed to load!"),j()})}}var e=null,f={session:{id:"session",data:{}},site:{id:"site",data:{},urls:{getLoadUrl:function(){return d+"getVolatilePrefsForSite/htmlEditor/"+e},getSaveUrl:function(){return d+"bulkSet"}}},global:{id:"global",data:null,urls:{getLoadUrl:function(){return d+"getVolatilePrefForKey/htmlEditor/global_preferences"},getSaveUrl:function(){return d+"set"}}}};return{loadGlobalPreferences:u,loadSitePreferences:v,global:{get:function(b){if(null===f.global.data)return console.error("Global user preferences failed to load!"),null;if(!a.isString(b))throw new Error("Getting a global user preference expects a key of type string but received: "+b);return a.cloneDeep(f.global.data[b])},getAll:function(){return null===f.global.data?(console.error("Global user preferences failed to load!"),null):a.cloneDeep(f.global.data)},set:function(b,c,d,e){if(null===f.global.data)return console.error("Global user preferences failed to load!"),void(e&&e("Global user preferences failed to load!"));if(!a.isString(b))throw new Error("Setting a global user preference expects a key of type string but received: "+b);a.isUndefined(c)&&(c=null),f.global.data[b]=c,t(f.global.id,d,e)}},site:{get:function(b){if(!a.isString(b))throw new Error("Getting a user preference for the site expects a key of type string but received: "+b);return a.cloneDeep(f.site.data[b]&&f.site.data[b].value)},getAll:function(){return a.cloneDeep(a.mapValues(f.site.data,"value"))},set:function(b,c,d,g){if(!a.isString(b))throw new Error("Setting a user preference for the site expects a key of type string but received: "+b);a.isUndefined(c)&&(c=null);var h={value:c,isDirty:!0};f.site.data[b]=h,e?t(f.site.id,d,g):d&&d()}},session:{get:function(b){if(!a.isString(b))throw new Error("Getting a session user preference expects a key of type string but received: "+b);return a.cloneDeep(f.session.data[b])},getAll:function(){return a.cloneDeep(f.session.data)},set:function(b,c,d){if(!a.isString(b))throw new Error("Setting a session user preference expects a key of type string but received: "+b);return f.session.data[b]=c,d&&d(),c}}}}var d=c.serviceTopology.premiumStateApiUrl;return d=d?d.replace(/\/getTpaPremiumState/,"-user-preferences-webapp/"):"http://editor.wix.com/_api/wix-user-preferences-webapp/",e});